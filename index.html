<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Hub | Cloud Sync Pro</title>
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quill-image-resize-module@3.0.0/image-resize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- THEME ENGINE --- */
        :root[data-theme="light"] { --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --nav-bg: #002d62; --primary: #0056b3; --border: #e2e8f0; --accent: #f1f5f9; }
        :root[data-theme="dark"] { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --nav-bg: #1e293b; --primary: #3b82f6; --border: #334155; --accent: #1e293b; }
        :root[data-theme="midnight"] { --bg: #020617; --card: #0f172a; --text: #e2e8f0; --nav-bg: #020617; --primary: #818cf8; --border: #1e293b; --accent: #1e293b; }
        :root[data-theme="forest"] { --bg: #064e3b; --card: #065f46; --text: #ecfdf5; --nav-bg: #042f2e; --primary: #10b981; --border: #047857; --accent: #065f46; }
        :root[data-theme="sunset"] { --bg: #450a0a; --card: #7f1d1d; --text: #fef2f2; --nav-bg: #450a0a; --primary: #f87171; --border: #991b1b; --accent: #7f1d1d; }

        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: var(--text); transition: all 0.3s ease; }
        nav { background: var(--nav-bg); color: white; padding: 0.8rem 10%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .container { max-width: 900px; margin: 1.5rem auto; padding: 0 20px; }

        #adminPanel { display: none; background: var(--card); padding: 25px; border-radius: 14px; border: 1px solid var(--border); margin-bottom: 25px; }
        .update-card { background: var(--card); border-radius: 14px; border: 1px solid var(--border); margin-bottom: 15px; overflow: hidden; }
        .card-header { padding: 18px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .card-body { display: none; padding: 20px 25px; border-top: 1px solid var(--border); }
        .card-body.active { display: block; }
        
        .btn { cursor: pointer; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-logout { background: transparent; border: 1px solid rgba(255,255,255,0.4); color: white; font-size: 0.75rem; }
        .theme-selector { padding: 5px; border-radius: 6px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); margin-right: 10px; }
        
        #loginModal, #resetModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: var(--card); padding: 30px; border-radius: 16px; width: 320px; text-align: center; border: 1px solid var(--border); }

        /* --- PRINT FIXES --- */
        @page { size: auto; margin: 5mm 10mm; } /* This removes the file location/URL footer */

        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                color: black !important; 
                background: white !important; 
                display: block !important;
            }
            table { width: 100%; border-collapse: collapse; table-layout: fixed; }
            thead { display: table-header-group; }
            .no-print { display: none !important; }
            .ql-editor { padding: 0 !important; overflow: visible !important; }
        }
    </style>
</head>
<body>

<div id="printArea" style="display: none;"></div>

<nav>
    <div style="font-weight:700; font-size: 1.2rem;">Update Hub</div>
    <div style="display: flex; align-items: center;">
        <select class="theme-selector" onchange="changeTheme(this.value)" id="themePicker">
            <option value="dark">üåô Dark</option>
            <option value="light">‚òÄÔ∏è Light</option>
            <option value="midnight">üåå Midnight</option>
            <option value="forest">üå≤ Forest</option>
            <option value="sunset">üåá Sunset</option>
        </select>
        <span id="roleLabel" style="font-size: 0.7rem; margin-right: 10px; opacity: 0.7;">Viewer</span>
        <button id="authBtn" class="btn btn-logout" onclick="openLogin()">Creator Login</button>
    </div>
</nav>

<div class="container">
    <section id="adminPanel">
        <h3 style="margin:0 0 15px 0;">Post New Update</h3>
        <input type="text" id="postTitle" placeholder="Title..." style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:1px solid var(--border); background: var(--bg); color: var(--text);">
        <div id="editor-container" style="height: 250px; background: white; color: black;"></div>
        <button class="btn btn-primary" id="submitBtn" onclick="handlePublish()" style="margin-top:15px;">Publish to Cloud</button>
    </section>

    <div style="margin: 20px 0;">
        <input type="text" id="searchInput" placeholder="üîç Search updates..." onkeyup="renderFeed()" style="width:100%; padding:14px 20px; border-radius:12px; border:1px solid var(--border); background: var(--card); color: var(--text);">
    </div>

    <div id="feedArea">Loading updates...</div>
</div>

<script>
    const SUPABASE_URL = 'https://yanqtshgdcxkploupbop.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhbnF0c2hnZGN4a3Bsb3VwYm9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5MTA1MTYsImV4cCI6MjA4NzQ4NjUxNn0.kc4BaLqhBOyRVAukVNlDbFcR1L1aSE1f9eiqjXkTm34';
    
    let _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let localUpdatesCache = [];
    let isCreator = false;
    let editTargetId = null;

    const quill = new Quill('#editor-container', {
        theme: 'snow',
        modules: { toolbar: [['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['link', 'image']] }
    });

    function printSpecificCard(id) {
        const item = localUpdatesCache.find(u => u.id == id);
        if (!item) return;
        const printArea = document.getElementById('printArea');
        
        printArea.innerHTML = `
            <table>
                <thead>
                    <tr>
                        <td>
                            <div style="border-bottom: 2px solid #334155; padding: 10px 0; margin-bottom: 15px;">
                                <h4 style="margin:0; color: #64748b; text-transform: uppercase; font-size: 0.8rem;">Update Hub</h4>
                                <h1 style="margin: 5px 0 0 0; color: #0f172a; font-size: 1.6rem;">${item.title}</h1>
                                <p style="margin: 5px 0 0 0; font-size: 0.75rem; color: #64748b;">Published: ${new Date(Number(item.timestamp)).toLocaleDateString()}</p>
                            </div>
                        </td>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <div class="ql-editor" style="color: #1e293b; line-height: 1.6; word-wrap: break-word;">
                                ${item.body}
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        `;
        
        window.print();
        printArea.innerHTML = '';
    }

    async function handlePublish() {
        const title = document.getElementById('postTitle').value.trim();
        const body = quill.root.innerHTML;
        if (!title || body === '<p><br></p>') return alert("Fill all fields.");
        try {
            if (editTargetId) await _supabase.from('compliance_updates').update({ title, body }).eq('id', editTargetId);
            else await _supabase.from('compliance_updates').insert([{ title, body, timestamp: Date.now() }]);
            resetEditor(); renderFeed();
        } catch (e) { alert("Sync Error."); }
    }

    async function renderFeed() {
        const feed = document.getElementById('feedArea');
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const { data: updates } = await _supabase.from('compliance_updates').select('*').order('timestamp', { ascending: false });
        
        localUpdatesCache = updates || []; 
        const filtered = localUpdatesCache.filter(u => u.title.toLowerCase().includes(searchTerm) || u.body.toLowerCase().includes(searchTerm));
        
        let html = '';
        filtered.forEach(u => {
            html += `
            <div class="update-card">
                <div class="card-header" onclick="this.parentElement.querySelector('.card-body').classList.toggle('active')">
                    <h2 style="margin:0; font-size:1rem; color: var(--primary);">‚ú¶ ${u.title}</h2>
                    <span style="font-size:0.7rem; opacity:0.6">${new Date(Number(u.timestamp)).toLocaleDateString()}</span>
                </div>
                <div class="card-body ql-editor">
                    <div>${u.body}</div>
                    <div style="margin-top:20px; border-top:1px solid var(--border); padding-top:15px; display:flex; gap:15px;" class="no-print">
                        <span style="font-size:0.75rem; cursor:pointer; font-weight:700; color:var(--primary)" onclick="printSpecificCard(${u.id})">Print This Update</span>
                        ${isCreator ? `<span style="font-size:0.75rem; cursor:pointer; opacity:0.7" onclick="loadEdit(${u.id})">Edit</span>` : ''}
                    </div>
                </div>
            </div>`;
        });
        feed.innerHTML = html || '<p style="text-align:center; padding:40px;">No updates found.</p>';
    }

    function changeTheme(theme) { document.documentElement.setAttribute('data-theme', theme); localStorage.setItem('hub-preferred-theme', theme); }
    function openLogin() { if (isCreator) { sessionStorage.clear(); isCreator = false; refreshUI(); } else { document.getElementById('loginModal').style.display = 'flex'; } }
    function refreshUI() { document.getElementById('adminPanel').style.display = isCreator ? 'block' : 'none'; renderFeed(); }
    function resetEditor() { editTargetId = null; document.getElementById('postTitle').value = ''; quill.setContents([]); }

    window.onload = () => {
        const savedTheme = localStorage.getItem('hub-preferred-theme') || 'dark';
        document.getElementById('themePicker').value = savedTheme;
        changeTheme(savedTheme);
        renderFeed();
    };
</script>
</body>
</html>