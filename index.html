<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compliance Hub | PWA Live Sync</title>
    
    <link rel="manifest" href="manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => console.log("SW error", err));
        }
    </script>
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quill-image-resize-module@3.0.0/image-resize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style id="theme-style">
        :root { --navy: #1e3a8a; --corp-blue: #3b82f6; --bg-gray: #f1f5f9; --text-dark: #334155; --card-bg: #ffffff; --border: #cbd5e1; --warning: #f87171; --ai-purple: #a78bfa; --nav-bg: #ffffff; }
        [data-theme="dark"] { --navy: #60a5fa; --corp-blue: #3b82f6; --bg-gray: #0f172a; --text-dark: #f1f5f9; --card-bg: #1e293b; --border: #334155; --nav-bg: #1e293b; }
        [data-theme="monochrome"] { --navy: #111827; --corp-blue: #4b5563; --bg-gray: #f3f4f6; --text-dark: #1f2937; --card-bg: #ffffff; --border: #9ca3af; --nav-bg: #e5e7eb; }
        [data-theme="ocean"] { --navy: #0e7490; --corp-blue: #06b6d4; --bg-gray: #ecfeff; --text-dark: #164e63; --card-bg: #ffffff; --border: #a5f3fc; --nav-bg: #cffafe; }
        [data-theme="gold"] { --navy: #78350f; --corp-blue: #b45309; --bg-gray: #fffbeb; --text-dark: #451a03; --card-bg: #ffffff; --border: #fde68a; --nav-bg: #fef3c7; }

        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg-gray); color: var(--text-dark); line-height: 1.6; }
        nav { background: var(--nav-bg); color: var(--navy); padding: 1rem 10%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid var(--border); }
        .container { max-width: 900px; margin: 1.5rem auto; padding: 0 20px; }
        
        #loginModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-content { background: var(--card-bg); color: var(--text-dark); padding: 30px; border-radius: 12px; width: 320px; text-align: center; border: 1px solid var(--border); }
        
        #adminPanel { display: none; background: var(--card-bg); padding: 30px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 40px; }
        .assistant-bar { background: rgba(167, 139, 250, 0.1); border: 1px solid var(--ai-purple); padding: 10px; border-radius: 8px; margin-bottom: 15px; display: flex; gap: 8px; }
        .btn-tool { background: var(--card-bg); border: 1px solid var(--border); color: var(--ai-purple); font-size: 0.7rem; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-weight: 600; }
        
        input, select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 15px; box-sizing: border-box; background: var(--card-bg); color: var(--text-dark); }
        .btn { cursor: pointer; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; }
        .btn-primary { background: var(--corp-blue); color: white; width: 100%; }
        .btn-logout { background: var(--border); color: var(--text-dark); font-size: 0.75rem; }
        
        .section-label { font-size: 0.75rem; font-weight: 700; color: #94a3b8; margin: 30px 0 10px; text-transform: uppercase; display: flex; align-items: center; gap: 10px; }
        .section-label::after { content: ""; flex: 1; height: 1px; background: var(--border); }
        .update-card { background: var(--card-bg); border-radius: 10px; border: 1px solid var(--border); margin-bottom: 12px; }
        .update-card.pinned { border-left: 4px solid var(--corp-blue); }
        .card-header { padding: 15px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .card-body { display: none; padding: 20px 25px; border-top: 1px solid var(--border); }
        .card-body.active { display: block; }
        .action-link { font-size: 0.7rem; cursor: pointer; font-weight: 700; margin-right: 15px; color: var(--corp-blue); }
        
        [data-theme="dark"] .ql-editor { color: white; }
        [data-theme="dark"] .ql-toolbar { background: #cbd5e1; border-radius: 6px 6px 0 0; }
    </style>
</head>
<body>

<div id="loginModal">
    <div class="modal-content">
        <h3>Creator Access</h3>
        <input type="password" id="passInput" placeholder="Password">
        <button class="btn btn-primary" onclick="checkAuth()">Login</button>
        <button class="btn" style="background:none;" onclick="closeModal()">Cancel</button>
    </div>
</div>

<nav>
    <div style="font-weight:700;">Compliance Hub</div>
    <div style="display: flex; align-items: center; gap: 10px;">
        <select id="themeSelect" onchange="changeTheme(this.value)" style="margin:0; width: auto; padding: 5px; font-size: 0.75rem;">
            <option value="light">Basic Light</option>
            <option value="dark">True Dark</option>
            <option value="monochrome">Monochrome</option>
            <option value="ocean">Ocean</option>
            <option value="gold">Gold</option>
        </select>
        <button id="authBtn" class="btn btn-logout" onclick="openModal()">Creator Login</button>
    </div>
</nav>

<div class="container">
    <section id="adminPanel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0;">Creator Controls</h3>
            <button class="btn-tool" style="color:var(--warning)" onclick="resetPassword()">Reset Password</button>
        </div>
        <hr style="border:0; border-top:1px solid var(--border); margin:15px 0;">
        <div class="assistant-bar">
            <button class="btn-tool" onclick="runAssistant('formal')">Professional</button>
            <button class="btn-tool" onclick="runAssistant('urgent')">Urgent</button>
        </div>
        <input type="text" id="postTitle" placeholder="Update Title...">
        <div id="editor-container" style="height: 200px; background: white; border-radius: 6px; color: black;"></div>
        <button class="btn btn-primary" id="submitBtn" onclick="handlePublish()" style="margin-top:15px;">Publish to Cloud</button>
    </section>

    <input type="text" id="searchInput" placeholder="üîç Search updates..." onkeyup="renderFeed()">
    <div id="feedArea">Loading updates...</div>
</div>

<script>
    const SUPABASE_URL = 'https://yanqtshgdcxkploupbop.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_PJ0m37ilVKj3S2cb5iHtew_b0X36oiC';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentPassB64 = localStorage.getItem('hub_pass') || "VGVhbUFkbWluMTIz"; 
    let isCreator = false;
    let editTargetId = null;
    let sessionTimer;

    const quill = new Quill('#editor-container', {
        theme: 'snow',
        modules: { toolbar: [['bold', 'italic'], [{ 'list': 'bullet' }], ['link', 'image']] }
    });

    function changeTheme(themeName) {
        document.documentElement.setAttribute('data-theme', themeName);
        localStorage.setItem('hub-theme', themeName);
    }

    function startSessionTimer() {
        clearTimeout(sessionTimer);
        sessionTimer = setTimeout(() => { if (isCreator) { alert("Session expired."); logout(); } }, 900000); 
    }

    function openModal() {
        if (isCreator) { if(confirm("Logout?")) logout(); }
        else { document.getElementById('loginModal').style.display = 'flex'; document.getElementById('passInput').focus(); }
    }

    function closeModal() { document.getElementById('loginModal').style.display = 'none'; }

    function checkAuth() {
        const input = document.getElementById('passInput').value;
        if (btoa(input) === currentPassB64) {
            isCreator = true;
            sessionStorage.setItem('active_session', Date.now());
            closeModal();
            refreshUI();
            startSessionTimer();
        } else { alert("Wrong Password."); }
    }

    function resetPassword() {
        const newPass = prompt("Enter new password:");
        if (newPass) {
            currentPassB64 = btoa(newPass);
            localStorage.setItem('hub_pass', currentPassB64);
            alert("Password updated for this device.");
        }
    }

    function logout() {
        isCreator = false;
        sessionStorage.clear();
        refreshUI();
        window.location.reload();
    }

    function refreshUI() {
        document.getElementById('adminPanel').style.display = isCreator ? 'block' : 'none';
        document.getElementById('authBtn').innerText = isCreator ? 'Logout' : 'Creator Login';
        renderFeed();
    }

    function setupRealtime() {
        _supabase.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'compliance_updates' }, () => { 
            renderFeed(); 
        }).subscribe();
    }

    async function handlePublish() {
        const title = document.getElementById('postTitle').value.trim();
        const body = quill.root.innerHTML;
        if (!title || body === '<p><br></p>') return alert("Fill all fields.");
        const btn = document.getElementById('submitBtn');
        btn.innerText = "Syncing...";
        try {
            if (editTargetId) { await _supabase.from('compliance_updates').update({ title, body }).eq('id', editTargetId); }
            else { await _supabase.from('compliance_updates').insert([{ title, body, timestamp: Date.now() }]); }
            resetEditor();
            startSessionTimer();
        } catch (e) { alert("Sync Failed."); }
        btn.innerText = "Publish to Cloud";
    }

    async function renderFeed() {
        const feed = document.getElementById('feedArea');
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        
        // --- THE FIX: ALWAYS CLEAR FEED BEFORE RENDERING ---
        feed.innerHTML = ""; 
        
        const { data: updates, error } = await _supabase.from('compliance_updates').select('*').order('timestamp', { ascending: false });
        
        if (error) { feed.innerHTML = "Error loading updates."; return; }
        
        const filtered = (updates || []).filter(u => u.title.toLowerCase().includes(searchTerm) || u.body.toLowerCase().includes(searchTerm));
        const FIFTEEN_DAYS = 1296000000;
        let html = '';
        const pinned = filtered.filter(u => (Date.now() - Number(u.timestamp)) < FIFTEEN_DAYS);
        const history = filtered.filter(u => (Date.now() - Number(u.timestamp)) >= FIFTEEN_DAYS);

        if (pinned.length > 0) { html += '<div class="section-label">Active Directives</div>'; pinned.forEach(u => html += generateCard(u, true)); }
        if (history.length > 0) { html += '<div class="section-label">Archive</div>'; history.forEach(u => html += generateCard(u, false)); }
        feed.innerHTML = html || '<p style="text-align:center; color:#999; margin-top:20px;">No updates found.</p>';
    }

    function generateCard(u, isPinned) {
        return `<div class="update-card ${isPinned ? 'pinned' : ''}">
                <div class="card-header" onclick="this.parentElement.querySelector('.card-body').classList.toggle('active')">
                    <h2 style="margin:0; font-size:0.95rem; font-weight:600;">${isPinned ? '‚óè ' : ''}${u.title}</h2>
                    <span style="font-size:0.7rem; opacity:0.6">${new Date(Number(u.timestamp)).toLocaleDateString()}</span>
                </div>
                <div class="card-body ql-editor">
                    ${u.body}
                    <div style="margin-top:15px; border-top:1px solid var(--border); padding-top:10px;">
                        <span class="action-link" onclick="window.print()">Print PDF</span>
                        ${isCreator ? `<span class="action-link" onclick="loadEdit(${u.id}, \`${u.title.replace(/'/g, "\\'")}\`, \`${u.body.replace(/'/g, "\\'")}\`)">Edit</span>
                        <span class="action-link" style="color:var(--warning)" onclick="deletePost(${u.id})">Delete</span>` : ''}
                    </div>
                </div></div>`;
    }

    async function deletePost(id) {
        if(confirm("Delete?")) { await _supabase.from('compliance_updates').delete().eq('id', id); startSessionTimer(); }
    }

    function loadEdit(id, title, body) {
        editTargetId = id; document.getElementById('postTitle').value = title; quill.root.innerHTML = body;
        document.getElementById('submitBtn').innerText = "Update Cloud Record"; window.scrollTo(0,0);
        startSessionTimer();
    }

    function resetEditor() { editTargetId = null; document.getElementById('postTitle').value = ''; quill.setContents([]); document.getElementById('submitBtn').innerText = "Publish to Cloud"; }

    function runAssistant(mode) {
        let text = quill.getText().trim();
        if(mode === 'urgent') quill.setText("URGENT: " + text.toUpperCase());
        else if(mode === 'formal') quill.setText("Official Notice: " + text);
        startSessionTimer();
    }

    window.onload = () => {
        setupRealtime();
        changeTheme(localStorage.getItem('hub-theme') || 'light');
        const session = sessionStorage.getItem('active_session');
        if (session && (Date.now() - session < 900000)) { isCreator = true; refreshUI(); startSessionTimer(); } 
        else { renderFeed(); }
    };
</script>
</body>
</html>